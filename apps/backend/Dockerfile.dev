# apps/backend/Dockerfile.dev
FROM node:22

# pnpm
RUN corepack enable && corepack prepare pnpm@9.0.0 --activate

WORKDIR /workspace

# 依存ファイルだけ先に（キャッシュ）
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json tsconfig.base.json ./
COPY apps/backend/package.json apps/backend/package.json
COPY apps/frontend/package.json apps/frontend/package.json
COPY packages/domain/package.json packages/domain/package.json

ENV NODE_ENV=development
RUN pnpm install --recursive --no-frozen-lockfile

# ソース
COPY . .

EXPOSE 3000 5173

# ⬇️ 起動時に "必ず" 再インストールして .bin を用意し、その後並行で両方の dev を起動
CMD sh -lc "\
  pnpm install --recursive --no-frozen-lockfile && \
  cd apps/backend && pnpm prisma generate && \
  (pnpm dev &) && \
  cd ../frontend && pnpm dev --host \
"
